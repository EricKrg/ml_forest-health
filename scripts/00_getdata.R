# Filename: 00_getdata.R

# TO DO: get data

#**********************************************************
# CONTENTS-------------------------------------------------
# 1 PACKAGES AND DATA PREPERATION
# 2 
#**********************************************************

#****************************************
# 1 PACKAGES AND DATA PREPERATION-------
#****************************************
pacman::p_load(raster, sp, sf, mapview, rgdal, gdalUtils)

#geopckg
sp28_sf <- sf::st_read("data/SP28_GIPUZKOA_V9b_DATOS_clase_2018_02_19.gpkg")

forest_inv <- sf::st_read("data/INV_FORESTAL_2016_10000_ETRS89.gpkg")

#raster

#dsn = "http://geo.hazi.eus/ows?service=WCS&version=2.0.1&request=GetCapabilities"
#dsn = "http://geo.hazi.eus/wcs?"
#dsn2 = "http://geo.hazi.eus/ows?service=WCS&version=2.0.1&request=DescribeCoverage&CoverageId=GEOEUSKADI__SENTINEL2_NDVI_DATA_FECHA"
#dsn describe coverage, NDVI 2015 - 2018
#dsn3 = "http://geo.hazi.eus/ows?service=WCS&version=2.0.1&request=GetCoverage&CoverageId=GEOEUSKADI__SENTINEL2_NDVI_DATA_FECHA"
#dsn3 download by coverageID
get <- "http://geo.hazi.eus/ows?service=WCS&version=2.0.1&request=GetCoverage&CoverageId="
#landsat 8
#l8 <- "http://geo.hazi.eus/ows?service=WCS&version=2.0.1&request=GetCoverage&CoverageId=GEOEUSKADI__LANDSAT8_NDVI_DATA_FECHA"
#download.file(l8, "l8time_ndvi.tif")

cov_id_15 <- c(
  "TELEDETEKZIOA__S2A_20150818T110635806Z_NDVI",
  "TELEDETEKZIOA__S2A_20150821T111616945Z_NDVI",
  "TELEDETEKZIOA__S2A_20150910T111633378Z_NDVI",
  "TELEDETEKZIOA__S2A_20150917T110653235Z_NDVI",
  "TELEDETEKZIOA__S2A_20150930T111858682Z_NDVI",
  "TELEDETEKZIOA__S2A_20151116T110736607Z_NDVI",
  "TELEDETEKZIOA__S2A_20151129T112140218Z_NDVI",
  "TELEDETEKZIOA__S2A_20151206T111905538Z_NDVI",
  "TELEDETEKZIOA__S2A_20151219T112151354Z_NDVI",
  "TELEDETEKZIOA__S2A_20151229T112948189Z_NDVI")

for(i in cov_id_15){
   print(i)
  download.file(paste0(get, i), paste0("data/raster/",i,".tif"))
}

cov_id_16 <- c(
  "TELEDETEKZIOA__S2A_20160118T112024275Z_NDVI",
  "TELEDETEKZIOA__S2A_20160217T111843605Z_NDVI",
  "TELEDETEKZIOA__S2A_20160318T111523431Z_NDVI",
  "TELEDETEKZIOA__S2A_20160417T111159116Z_NDVI",
  "TELEDETEKZIOA__S2A_20160507T111829150Z_NDVI",
  "TELEDETEKZIOA__S2A_20160527T111025709Z_NDVI",
  "TELEDETEKZIOA__S2A_20160613T110559700Z_NDVI",
  "TELEDETEKZIOA__S2A_20160616T111022709Z_NDVI",
  "TELEDETEKZIOA__S2A_20160706T110921380Z_NDVI",
  "TELEDETEKZIOA__S2A_20160713T110542192Z_NDVI",
  "TELEDETEKZIOA__S2A_20160726T111748462Z_NDVI",
  "GEOEUSKADI__S2A_20160802T110307060Z_NDVI",
  "GEOEUSKADI__S2A_20160901T110708860Z_NDVI",
  "GEOEUSKADI__S2A_20160911T110438472Z_NDVI",
  "TELEDETEKZIOA__S2A_20161011T110223381Z_NDVI",
  "GEOEUSKADI__S2A_20161021T110318551Z_NDVI",
  "TELEDETEKZIOA__S2A_20161031T110202460Z_NDVI",
  "GEOEUSKADI__S2A_20161103T111839668Z_NDVI",
  "TELEDETEKZIOA__S2A_20161110T110832984Z_NDVI",
  "GEOEUSKADI__S2A_20161203T111751494Z_NDVI"
  )

for(i in cov_id_16){
  print(i)
  download.file(paste0(get, i), paste0("data/raster/",i,".tif"))
}

cov_id_17 <- c(
  "TELEDETEKZIOA__S2A_20170129T110306462Z_NDVI",
  "GEOEUSKADI__S2A_20170201T111820156Z_NDVI",
  "TELEDETEKZIOA__S2A_20170208T110245538Z_NDVI",
  "TELEDETEKZIOA__S2A_20170218T110125497Z_NDVI",
  "TELEDETEKZIOA__S2A_20170221T111821429Z_NDVI",
  "GEOEUSKADI__S2A_20170310T105951010Z_NDVI",
  "TELEDETEKZIOA__S2A_20170320T110651661Z_NDVI",
  "TELEDETEKZIOA__S2A_20170323T111323449Z_NDVI",
  "TELEDETEKZIOA__S2A_20170409T110529978Z_NDVI",
  "TELEDETEKZIOA__S2A_20170412T111708859Z_NDVI",
  "GEOEUSKADI__S2A_20170419T110601310Z_NDVI",
  "TELEDETEKZIOA__S2A_20170422T111300457Z_NDVI",
  "TELEDETEKZIOA__S2A_20170429T110525766Z_NDVI",
  "TELEDETEKZIOA__S2A_20170519T110530368Z_NDVI",
  "GEOEUSKADI__S2A_20170522T110912028Z_NDVI",
  "TELEDETEKZIOA__S2A_20170601T111225371Z_NDVI",
  "TELEDETEKZIOA__S2A_20170611T111012353Z_NDVI",
  "GEOEUSKADI__S2A_20170618T110415683Z_NDVI",
  "TELEDETEKZIOA__S2A_20170621T111222373Z_NDVI",
  "TELEDETEKZIOA__S2A_20170628T110445682Z_NDVI",
  "GEOEUSKADI__S2B_20170703T110426043Z_NDVI",
  "TELEDETEKZIOA__S2B_20170706T111832836Z_NDVI",
  "TELEDETEKZIOA__S2A_20170711T111223375Z_NDVI",
  "TELEDETEKZIOA__S2B_20170713T110523761Z_NDVI",
  "TELEDETEKZIOA__S2B_20170716T111603451Z_NDVI",
  "TELEDETEKZIOA__S2A_20170718T110452293Z_NDVI",
  "TELEDETEKZIOA__S2B_20170723T110444543Z_NDVI",
  "TELEDETEKZIOA__S2A_20170728T110406866Z_NDVI",
  "GEOEUSKADI__S2B_20170802T110522761Z_NDVI",
  "TELEDETEKZIOA__S2B_20170812T110438939Z_NDVI",
  "TELEDETEKZIOA__S2A_20170817T110525231Z_NDVI",
  "TELEDETEKZIOA__S2A_20170820T111220771Z_NDVI",
  "GEOEUSKADI__S2B_20170822T110527982Z_NDVI",
  "TELEDETEKZIOA__S2B_20170825T111247234Z_NDVI",
  "TELEDETEKZIOA__S2A_20170830T110910029Z_NDVI",
  "TELEDETEKZIOA__S2B_20170901T110442152Z_NDVI",
  "TELEDETEKZIOA__S2B_20170904T111825839Z_NDVI",
  "TELEDETEKZIOA__S2A_20170916T110523550Z_NDVI",
  "TELEDETEKZIOA__S2A_20170919T111808254Z_NDVI",
  "GEOEUSKADI__S2B_20170924T111106888Z_NDVI",
  "TELEDETEKZIOA__S2A_20170926T110656196Z_NDVI",
  "TELEDETEKZIOA__S2A_20170929T111602827Z_NDVI",
  "TELEDETEKZIOA__S2A_20171009T111500339Z_NDVI",
  "GEOEUSKADI__S2B_20171011T110203161Z_NDVI",
  "TELEDETEKZIOA__S2B_20171014T111716004Z_NDVI",
  "TELEDETEKZIOA__S2A_20171016T110313200Z_NDVI",
  "TELEDETEKZIOA__S2A_20171019T111235475Z_NDVI",
  "TELEDETEKZIOA__S2A_20171026T110717194Z_NDVI",
  "TELEDETEKZIOA__S2B_20171031T110201279Z_NDVI",
  "TELEDETEKZIOA__S2B_20171103T111458422Z_NDVI",
  "TELEDETEKZIOA__S2A_20171105T110231456Z_NDVI",
  "TELEDETEKZIOA__S2B_20171113T111817339Z_NDVI",
  "TELEDETEKZIOA__S2A_20171118T111633239Z_NDVI",
  "TELEDETEKZIOA__S2B_20171120T110332460Z_NDVI",
  "TELEDETEKZIOA__S2B_20171123T111629809Z_NDVI",
  "TELEDETEKZIOA__S2A_20171128T111835828Z_NDVI",
  "TELEDETEKZIOA__S2B_20171130T110442541Z_NDVI",
  "GEOEUSKADI__S2A_20171205T110426462Z_NDVI",
  "TELEDETEKZIOA__S2A_20171215T110516933Z_NDVI",
  "TELEDETEKZIOA__S2B_20171220T110639514Z_NDVI",
  "TELEDETEKZIOA__S2A_20171225T110447460Z_NDVI",
  "TELEDETEKZIOA__S2B_20171230T110439456Z_NDVI")
  
for(i in cov_id_17){
  print(i)
  download.file(paste0(get, i), paste0("data/raster/",i,".tif"))
}

  
  
## NOT WORKING WCS STUFF
l1 <- XML::newXMLNode("WCS_GDAL")
l1.s <- XML::newXMLNode("ServiceURL", dsn, parent=l1)
l1.l <- XML::newXMLNode("CoverageName", "SENTINEL2 Time Series NDVI", parent=l1)
l1
xml.out = "wcs_forest_health.xml"
XML::saveXML(l1, file=xml.out)
#check layer
system(paste("gdalinfo", xml.out))

# Download raster as GeoTIFF 
file.out <- ''
system(paste('gdal_translate', ' ', xml.out, file.out))


